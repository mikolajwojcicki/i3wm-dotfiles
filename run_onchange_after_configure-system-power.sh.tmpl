{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" -}}
#!/bin/bash
set -euo pipefail

echo "Configuring System Power Settings..."

# --- 1. Configure Battery Thresholds (Custom Service) ---
# Since TLP conflicts with power-profiles-daemon, we create a simple
# systemd service to set the charge thresholds via the kernel sysfs interface.

BATTERY_SERVICE_FILE="/etc/systemd/system/battery-charge-thresholds.service"
BATTERY_SERVICE_CONTENT="[Unit]
Description=Set ThinkPad Battery Charge Thresholds
After=multi-user.target

[Service]
Type=oneshot
# Check if BAT0 exists, then set thresholds. 
# Start at 75%, Stop at 80%
ExecStart=/bin/sh -c 'if [ -d /sys/class/power_supply/BAT0 ]; then echo 75 > /sys/class/power_supply/BAT0/charge_control_start_threshold; echo 80 > /sys/class/power_supply/BAT0/charge_control_end_threshold; fi'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target"

if [ ! -f "$BATTERY_SERVICE_FILE" ] || [ "$(cat "$BATTERY_SERVICE_FILE")" != "$BATTERY_SERVICE_CONTENT" ]; then
    echo "Creating Battery Threshold Service..."
    echo "$BATTERY_SERVICE_CONTENT" | sudo tee "$BATTERY_SERVICE_FILE" > /dev/null
    sudo systemctl daemon-reload
fi

# --- 2. Configure Thermald (Adaptive Mode) ---
# We need to override the systemd service to add the --adaptive flag

THERMALD_OVERRIDE_DIR="/etc/systemd/system/thermald.service.d"
THERMALD_OVERRIDE_FILE="$THERMALD_OVERRIDE_DIR/override.conf"
THERMALD_CONTENT="[Service]
ExecStart=
ExecStart=/usr/sbin/thermald --systemd --adaptive --ignore-cpuid-check"

if [ ! -f "$THERMALD_OVERRIDE_FILE" ]; then
    echo "Configuring Thermald Adaptive Mode..."
    sudo mkdir -p "$THERMALD_OVERRIDE_DIR"
    echo "$THERMALD_CONTENT" | sudo tee "$THERMALD_OVERRIDE_FILE" > /dev/null
    sudo systemctl daemon-reload
fi

# --- 3. Enable and Start Services ---
echo "Enabling and starting services..."
sudo systemctl enable --now power-profiles-daemon
sudo systemctl enable --now battery-charge-thresholds.service
sudo systemctl restart thermald

echo "Power management configuration complete."
{{ end -}}